{% extends "base.html" %}
{% block content %}
<h2>Создать требование-накладную</h2>
<form method="post">
    <div class="grid">
        <label>Организация
            <select name="organization_id" required>
                {% for o in orgs %}
                <option value="{{ o.id }}">{{ o.name }}</option>
                {% endfor %}
            </select>
        </label>

        <label>Склад (отправитель)
            <input type="text" name="warehouse_id" required placeholder="Название склада или код" style="width:100%;">
        </label>

        <label>Подразделение
            <select name="department_id" required>
                {% for d in deps %}
                <option value="{{ d.id }}">{{ d.name }}</option>
                {% endfor %}
            </select>
        </label>

        <label>Сотрудник
            <select name="employee_id" required>
                {% for e in emps %}
                <option value="{{ e.id }}">{{ e.last_name }} {{ e.first_name }}</option>
                {% endfor %}
            </select>
        </label>

        <label>Номер заявки
            <input type="text" name="requisition_number" required>
        </label>

        <label>Дата
            <input type="date" name="requisition_date" required>
        </label>

        <label>Назначение
            <textarea name="purpose" rows="2" style="width:100%;"></textarea>
        </label>
    </div>

    <h3>Позиции</h3>
    <table id="items-table">
        <thead>
            <tr>
                <th>Товар</th>
                <th>Ед.</th>
                <th>Запрошено</th>
                <th>Выдано</th>
                <th>Цена</th>
                <th>Сумма</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="items-body">
            <tr>
                <td>
                    <select name="product_id" onchange="syncRow(this)">
                        {% for p in prods %}
                        <option value="{{ p.id }}" data-name="{{ p.name }}" data-unit="{{ p.unit.name }}">{{ p.name }} ({{ p.unit.name }})</option>
                        {% endfor %}
                    </select>
                    <input type="hidden" name="product_name" value="">
                    <input type="hidden" name="unit" value="">
                </td>
                <td class="unit-cell">{{ prods[0].unit.name if prods|length > 0 else 'шт' }}</td>
                <td><input type="number" name="requested_quantity" min="0" step="0.01"></td>
                <td><input type="number" name="issued_quantity" min="0" step="0.01" oninput="recalcTotals()"></td>
                <td><input type="number" name="price" step="0.01" oninput="recalcTotals()"></td>
                <td><input type="number" name="amount" step="0.01" readonly></td>
                <td><button class="btn danger" type="button" onclick="removeRow(this)">✖</button></td>
            </tr>
        </tbody>
    </table>

    <div class="toolbar">
        <button class="btn" type="button" onclick="addRow()">Добавить строку</button>
    </div>

    <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
        <div>
            <strong>Итого: </strong><span id="total-display">0.00</span>
        </div>
        <div>
            <input type="hidden" name="total_amount" id="total_amount" value="0">
            <button class="btn" type="submit">Сохранить</button>
        </div>
    </div>
</form>

<script>
function recalcTotals() {
    const rows = document.querySelectorAll('#items-body tr');
    let total = 0;
    rows.forEach(r => {
        const qty = parseFloat(r.querySelector('input[name="issued_quantity"]').value) || 0;
        const price = parseFloat(r.querySelector('input[name="price"]').value) || 0;
        const amountEl = r.querySelector('input[name="amount"]');
        const amount = +(qty * price).toFixed(2);
        amountEl.value = amount;
        total += amount;
    });
    document.getElementById('total-display').innerText = total.toFixed(2);
    document.getElementById('total_amount').value = total.toFixed(2);
}

function syncRow(selectEl) {
    const tr = selectEl.closest('tr');
    const selected = selectEl.options[selectEl.selectedIndex];
    const name = selected.dataset.name || selected.text;
    const unit = selected.dataset.unit || '';
    const pname = tr.querySelector('input[name="product_name"]');
    const punit = tr.querySelector('input[name="unit"]');
    const unitCell = tr.querySelector('.unit-cell');
    if (pname) pname.value = name;
    if (punit) punit.value = unit;
    if (unitCell) unitCell.innerText = unit;
}

function addRow() {
    const body = document.getElementById('items-body');
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>
            <select name="product_id" onchange="syncRow(this)">
                {% for p in prods %}
                <option value="{{ p.id }}" data-name="{{ p.name }}" data-unit="{{ p.unit.name }}">{{ p.name }} ({{ p.unit.name }})</option>
                {% endfor %}
            </select>
            <input type="hidden" name="product_name" value="">
            <input type="hidden" name="unit" value="">
        </td>
        <td class="unit-cell">{{ prods[0].unit.name if prods|length > 0 else 'шт' }}</td>
        <td><input type="number" name="requested_quantity" min="0" step="0.01"></td>
        <td><input type="number" name="issued_quantity" min="0" step="0.01" oninput="recalcTotals()"></td>
        <td><input type="number" name="price" step="0.01" oninput="recalcTotals()"></td>
        <td><input type="number" name="amount" step="0.01" readonly></td>
        <td><button class="btn danger" type="button" onclick="removeRow(this)">✖</button></td>
    `;
    body.appendChild(tr);
    recalcTotals();
}
function removeRow(btn) {
    const tr = btn.closest('tr');
    tr.parentNode.removeChild(tr);
    recalcTotals();
}
document.addEventListener('change', recalcTotals);
document.addEventListener('input', recalcTotals);
recalcTotals();
</script>
{% endblock %}
