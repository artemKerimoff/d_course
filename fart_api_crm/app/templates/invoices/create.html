{% extends "base.html" %}
{% block content %}
<h2>Создать Счет-фактура</h2>
<form method="post">
    <div class="grid">
        <label>Организация
            <select name="organization_id" required>
                {% for o in orgs %}
                <option value="{{ o.id }}">{{ o.name }}</option>
                {% endfor %}
            </select>
        </label>

        <label>Поставщик
            <select name="supplier_id" required>
                {% for s in suppliers %}
                <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
            </select>
        </label>

        <label>Номер счёта
            <input type="text" name="invoice_number" required>
        </label>

        <label>Дата счёта
            <input type="date" name="invoice_date" required>
        </label>

        <label>Дата оплаты
            <input type="date" name="payment_due_date">
        </label>

        <label>Договор №
            <input type="text" name="contract_number">
        </label>

        <label>Дата договора
            <input type="date" name="contract_date">
        </label>
    </div>

    <!-- totals are required by server; keep hidden inputs and fill them on submit (JS sets values) -->
    <input type="hidden" name="total_without_vat">
    <input type="hidden" name="vat_amount">
    <input type="hidden" name="total_with_vat">

    <h3>Позиции</h3>
    <table id="items-table">
        <thead>
            <tr>
                <th>№</th>
                <th>Код</th>
                <th>Товар</th>
                <th>Ед.</th>
                <th>Цена</th>
                <th>Кол-во</th>
                <th>Сумма без НДС</th>
                <th>Ставка НДС, %</th>
                <th>Сумма НДС</th>
                <th>Сумма с НДС</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="items-body">
            <tr>
                <td class="row-num">1</td>
                <td class="code-cell">{{ prods[0].id if prods|length > 0 else '' }}</td>
                <td>
                    <select name="product_id" class="product-select">
                        {% for p in prods %}
                        <option value="{{ p.id }}" data-name="{{ p.name }}" data-unit="{{ p.unit.name }}" data-code="{{ p.id }}">{{ p.name }} ({{ p.unit.name }})</option>
                        {% endfor %}
                    </select>
                    <input type="hidden" name="product_name">
                    <input type="hidden" name="unit">
                </td>
                <td class="unit-cell">{{ prods[0].unit.name if prods|length > 0 else 'шт' }}</td>
                <td><input type="number" name="price" class="price" step="0.01"></td>
                <td><input type="number" name="quantity" class="qty" min="0" step="0.001"></td>
                <td><input type="number" name="amount_without_vat" class="amount_no_vat" step="0.01" readonly></td>
                <td><input type="number" name="vat_rate" class="vat" step="0.1" min="0" value="20"></td>
                <td><input type="number" name="item_vat_amount" class="item_vat_amount" step="0.01" readonly></td>
                <td><input type="number" name="amount_with_vat" class="amount_with_vat" step="0.01" readonly></td>
                <td><button class="btn danger" type="button" onclick="removeRow(this)">✖</button></td>
            </tr>
        </tbody>
    </table>

    <div class="toolbar">
        <button class="btn" type="button" onclick="addRow()">Добавить строку</button>
    </div>

    <div class="totals" style="text-align:right; margin-top:10px;">
        <div>Итого без НДС: <strong id="total-no">0.00</strong></div>
        <div>Сумма НДС: <strong id="total-vat">0.00</strong></div>
        <div>Итого с НДС: <strong id="total-with">0.00</strong></div>
    </div>

    <button class="btn" type="submit">Сохранить</button>
</form>

<script>
function parseNumber(v){
    const n = parseFloat(v);
    return isNaN(n)?0:n;
}

function recalcRow(tr){
    const qty = parseNumber(tr.querySelector('.qty').value);
    const price = parseNumber(tr.querySelector('.price').value); // price without VAT
    const vat = parseNumber(tr.querySelector('.vat') ? tr.querySelector('.vat').value : 0);
    const noVat = qty * price;
    const vatAmt = noVat * (vat/100);
    const withVat = noVat + vatAmt;

    const noVatEl = tr.querySelector('.amount_no_vat');
    const vatElHidden = tr.querySelector('.item_vat_amount');
    const withVatEl = tr.querySelector('.amount_with_vat');

    if(noVatEl) noVatEl.value = noVat.toFixed(2);
    if(vatElHidden) vatElHidden.value = vatAmt.toFixed(2);
    if(withVatEl) withVatEl.value = withVat.toFixed(2);
}

function recalcTotals(){
    let totalNo = 0, totalVat = 0, totalWith = 0;
    document.querySelectorAll('#items-body tr').forEach(tr=>{
        const no = parseNumber(tr.querySelector('.amount_no_vat').value);
        const withv = parseNumber(tr.querySelector('.amount_with_vat').value);
        const vat = withv - no;
        totalNo += no; totalVat += vat; totalWith += withv;
    });
    const totalNoInput = document.querySelector('input[name="total_without_vat"]');
    const vatInput = document.querySelector('input[name="vat_amount"]');
    const totalWithInput = document.querySelector('input[name="total_with_vat"]');
    if(totalNoInput) totalNoInput.value = totalNo.toFixed(2);
    if(vatInput) vatInput.value = totalVat.toFixed(2);
    if(totalWithInput) totalWithInput.value = totalWith.toFixed(2);
    const noEl = document.getElementById('total-no');
    const vatEl = document.getElementById('total-vat');
    const withEl = document.getElementById('total-with');
    if(noEl) noEl.textContent = totalNo.toFixed(2);
    if(vatEl) vatEl.textContent = totalVat.toFixed(2);
    if(withEl) withEl.textContent = totalWith.toFixed(2);
}

function wireRow(tr){
    const select = tr.querySelector('.product-select');
    const nameInput = tr.querySelector('input[name="product_name"]');
    const unitInput = tr.querySelector('input[name="unit"]');
    const codeCell = tr.querySelector('.code-cell');
    const unitCell = tr.querySelector('.unit-cell');
    const qty = tr.querySelector('.qty');
    const price = tr.querySelector('.price');
    const vat = tr.querySelector('.vat');

    const onchange = ()=>{
        const opt = select.options[select.selectedIndex];
        if(nameInput) nameInput.value = opt.dataset.name || '';
        if(unitInput) unitInput.value = opt.dataset.unit || '';
        if(unitCell) unitCell.textContent = opt.dataset.unit || unitCell.textContent;
        if(codeCell) codeCell.textContent = opt.dataset.code || '';
        recalcRow(tr);
        recalcTotals();
    };

    [select, qty, price, vat].forEach(el=> el && el.addEventListener('change', onchange));
}

function addRow(){
    const body = document.getElementById('items-body');
    const index = body.querySelectorAll('tr').length + 1;
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td class="row-num">${index}</td>
        <td class="code-cell"></td>
        <td>
            <select name="product_id" class="product-select">
                {% for p in prods %}
                <option value="{{ p.id }}" data-name="{{ p.name }}" data-unit="{{ p.unit.name }}" data-code="{{ p.id }}">{{ p.name }} ({{ p.unit.name }})</option>
                {% endfor %}
            </select>
            <input type="hidden" name="product_name">
            <input type="hidden" name="unit">
        </td>
        <td class="unit-cell">{{ prods[0].unit.name if prods|length > 0 else 'шт' }}</td>
        <td><input type="number" name="price" class="price" step="0.01"></td>
        <td><input type="number" name="quantity" class="qty" min="0" step="0.001"></td>
        <td><input type="number" name="amount_without_vat" class="amount_no_vat" step="0.01" readonly></td>
        <td><input type="number" name="vat_rate" class="vat" step="0.1" min="0" value="20"></td>
        <td><input type="number" name="item_vat_amount" class="item_vat_amount" step="0.01" readonly></td>
        <td><input type="number" name="amount_with_vat" class="amount_with_vat" step="0.01" readonly></td>
        <td><button class="btn danger" type="button" onclick="removeRow(this)">✖</button></td>
    `;
    body.appendChild(tr);
    wireRow(tr);
}

function removeRow(btn){
    const tr = btn.closest('tr');
    tr.parentNode.removeChild(tr);
    // reindex rows
    document.querySelectorAll('#items-body tr').forEach((r,i)=> r.querySelector('.row-num').textContent = i+1);
    recalcTotals();
}

document.querySelectorAll('#items-body tr').forEach(wireRow);
recalcTotals();

window.addRow = addRow;
window.removeRow = removeRow;

// ensure totals are calculated and hidden inputs are set before submitting the form
document.addEventListener('DOMContentLoaded', function(){
    const form = document.querySelector('form');
    if(!form) return;
    form.addEventListener('submit', function(e){
        recalcTotals();
        const totalNoEl = document.querySelector('input[name="total_without_vat"]');
        const vatEl = document.querySelector('input[name="vat_amount"]');
        const totalWithEl = document.querySelector('input[name="total_with_vat"]');
        if(totalNoEl && vatEl && totalWithEl){
            const totalNo = parseFloat(totalNoEl.value || 0);
            const totalVat = parseFloat(vatEl.value || 0);
            const totalWith = parseFloat(totalWithEl.value || 0);
            totalNoEl.value = (isNaN(totalNo)?0:totalNo).toFixed(2);
            vatEl.value = (isNaN(totalVat)?0:totalVat).toFixed(2);
            totalWithEl.value = (isNaN(totalWith)?0:totalWith).toFixed(2);
        }
    });
});
</script>
{% endblock %}
