{% extends "base.html" %}
{% block content %}
<h2>Редактировать Счет-фактура #{{ invoice.id }}</h2>
<form method="post">
    <div class="grid">
        <label>Организация
            <select name="organization_id" required>
                {% for o in orgs %}
                <option value="{{ o.id }}" {% if invoice.organization_id == o.id %}selected{% endif %}>{{ o.name }}</option>
                {% endfor %}
            </select>
        </label>

        <label>Поставщик
            <select name="supplier_id" required>
                {% for s in suppliers %}
                <option value="{{ s.id }}" {% if invoice.supplier_id == s.id %}selected{% endif %}>{{ s.name }}</option>
                {% endfor %}
            </select>
        </label>

        <label>Номер счёта
            <input type="text" name="invoice_number" value="{{ invoice.invoice_number }}" required>
        </label>

        <label>Дата счёта
            <input type="date" name="invoice_date" value="{{ invoice.invoice_date }}" required>
        </label>

        <label>Дата оплаты
            <input type="date" name="payment_due_date" value="{{ invoice.payment_due_date or '' }}">
        </label>
    </div>

    <h3>Позиции</h3>
    <table id="items-table">
        <thead>
            <tr>
                <th>№</th>
                <th>Код</th>
                <th>Товар</th>
                <th>Ед.</th>
                <th>Цена</th>
                <th>Кол-во</th>
                <th>Сумма без НДС</th>
                <th>Ставка НДС, %</th>
                <th>Сумма НДС</th>
                <th>Сумма с НДС</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="items-body">
            {% for it in invoice.items %}
            <tr>
                <td class="row-num">{{ loop.index }}</td>
                <td class="code-cell">{{ it.product_id }}</td>
                <td>
                    <select name="product_id" class="product-select">
                        {% for p in prods %}
                        <option value="{{ p.id }}" data-name="{{ p.name }}" data-unit="{{ p.unit.name }}" data-code="{{ p.id }}" {% if it.product_id == p.id %}selected{% endif %}>{{ p.name }} ({{ p.unit.name }})</option>
                        {% endfor %}
                    </select>
                    <input type="hidden" name="product_name" value="{{ it.product_name }}">
                    <input type="hidden" name="unit" value="{{ it.unit }}">
                </td>
                <td class="unit-cell">{{ it.unit }}</td>
                <td><input type="number" name="price" class="price" step="0.01" value="{{ it.price }}"></td>
                <td><input type="number" name="quantity" class="qty" min="0" step="0.001" value="{{ it.quantity }}"></td>
                <td><input type="number" name="amount_without_vat" class="amount_no_vat" step="0.01" value="{{ it.amount_without_vat }}" readonly></td>
                <td><input type="number" name="vat_rate" class="vat" step="0.1" min="0" value="{{ it.vat_rate|default(20) }}"></td>
                <td><input type="number" name="item_vat_amount" class="item_vat_amount" step="0.01" value="{{ it.vat_amount }}" readonly></td>
                <td><input type="number" name="amount_with_vat" class="amount_with_vat" step="0.01" value="{{ it.amount_with_vat }}" readonly></td>
                <td><button class="btn danger" type="button" onclick="removeRow(this)">✖</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- totals shown below; keep hidden inputs for submission (JS fills them) -->
    <input type="hidden" name="total_without_vat" value="{{ invoice.total_without_vat }}">
    <input type="hidden" name="vat_amount" value="{{ invoice.vat_amount }}">
    <input type="hidden" name="total_with_vat" value="{{ invoice.total_with_vat }}">

    <div class="toolbar">
        <button class="btn" type="button" onclick="addRow()">Добавить строку</button>
    </div>

    <div class="totals" style="text-align:right; margin-top:10px;">
        <div>Итого без НДС: <strong id="total-no">0.00</strong></div>
        <div>Сумма НДС: <strong id="total-vat">0.00</strong></div>
        <div>Итого с НДС: <strong id="total-with">0.00</strong></div>
    </div>

    <button class="btn" type="submit">Сохранить</button>
</form>

<script>
function parseNumber(v){
    const n = parseFloat(v);
    return isNaN(n)?0:n;
}

function recalcRow(tr){
    const qty = parseNumber(tr.querySelector('.qty').value);
    const price = parseNumber(tr.querySelector('.price').value);
    const vat = parseNumber(tr.querySelector('.vat') ? tr.querySelector('.vat').value : 0);
    const noVat = qty * price;
    const vatAmt = noVat * (vat/100);
    const withVat = noVat + vatAmt;
    const noVatEl = tr.querySelector('.amount_no_vat');
    const vatElHidden = tr.querySelector('.item_vat_amount');
    const withVatEl = tr.querySelector('.amount_with_vat');
    if(noVatEl) noVatEl.value = noVat.toFixed(2);
    if(vatElHidden) vatElHidden.value = vatAmt.toFixed(2);
    if(withVatEl) withVatEl.value = withVat.toFixed(2);
}

function recalcTotals(){
    let totalNo = 0, totalVat = 0, totalWith = 0;
    document.querySelectorAll('#items-body tr').forEach(tr=>{
        const no = parseNumber(tr.querySelector('.amount_no_vat').value);
        const withv = parseNumber(tr.querySelector('.amount_with_vat').value);
        const vat = withv - no;
        totalNo += no; totalVat += vat; totalWith += withv;
    });
    document.querySelector('input[name="total_without_vat"]').value = totalNo.toFixed(2);
    document.querySelector('input[name="vat_amount"]').value = totalVat.toFixed(2);
    document.querySelector('input[name="total_with_vat"]').value = totalWith.toFixed(2);
    const noEl = document.getElementById('total-no');
    const vatEl = document.getElementById('total-vat');
    const withEl = document.getElementById('total-with');
    if(noEl) noEl.textContent = totalNo.toFixed(2);
    if(vatEl) vatEl.textContent = totalVat.toFixed(2);
    if(withEl) withEl.textContent = totalWith.toFixed(2);
}

function wireRow(tr){
    const select = tr.querySelector('.product-select');
    const nameInput = tr.querySelector('input[name="product_name"]');
    const unitInput = tr.querySelector('input[name="unit"]');
    const codeCell = tr.querySelector('.code-cell');
    const unitCell = tr.querySelector('.unit-cell');
    const qty = tr.querySelector('.qty');
    const price = tr.querySelector('.price');
    const vat = tr.querySelector('.vat');

    const onchange = ()=>{
        const opt = select.options[select.selectedIndex];
        if(nameInput) nameInput.value = opt.dataset.name || '';
        if(unitInput) unitInput.value = opt.dataset.unit || '';
        if(unitCell) unitCell.textContent = opt.dataset.unit || unitCell.textContent;
        if(codeCell) codeCell.textContent = opt.dataset.code || codeCell.textContent;
        recalcRow(tr);
        recalcTotals();
    };

    [select, qty, price, vat].forEach(el=> el && el.addEventListener('change', onchange));
}

function addRow(){
    const body = document.getElementById('items-body');
    const index = body.querySelectorAll('tr').length + 1;
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td class="row-num">${index}</td>
        <td class="code-cell"></td>
        <td>
            <select name="product_id" class="product-select">
                {% for p in prods %}
                <option value="{{ p.id }}" data-name="{{ p.name }}" data-unit="{{ p.unit.name }}" data-code="{{ p.id }}">{{ p.name }} ({{ p.unit.name }})</option>
                {% endfor %}
            </select>
            <input type="hidden" name="product_name">
            <input type="hidden" name="unit">
        </td>
        <td class="unit-cell">{{ prods[0].unit.name if prods|length > 0 else 'шт' }}</td>
        <td><input type="number" name="price" class="price" step="0.01"></td>
        <td><input type="number" name="quantity" class="qty" min="0" step="0.001"></td>
        <td><input type="number" name="amount_without_vat" class="amount_no_vat" step="0.01" readonly></td>
        <td><input type="number" name="vat_rate" class="vat" step="0.1" min="0" value="20"></td>
        <td><input type="number" name="item_vat_amount" class="item_vat_amount" step="0.01" readonly></td>
        <td><input type="number" name="amount_with_vat" class="amount_with_vat" step="0.01" readonly></td>
        <td><button class="btn danger" type="button" onclick="removeRow(this)">✖</button></td>
    `;
    body.appendChild(tr);
    wireRow(tr);
}

function removeRow(btn){
    const tr = btn.closest('tr');
    tr.parentNode.removeChild(tr);
    // reindex rows
    document.querySelectorAll('#items-body tr').forEach((r,i)=> r.querySelector('.row-num').textContent = i+1);
    recalcTotals();
}

document.querySelectorAll('#items-body tr').forEach(tr=>{ wireRow(tr); recalcRow(tr);} );
recalcTotals();

window.addRow = addRow;
window.removeRow = removeRow;
</script>
{% endblock %}
